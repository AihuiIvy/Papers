# Github敏感信息泄露监控
Feei <feei#feei> 2018/01

## 1. 漏洞背景
Github作为开源代码平台，给程序员提供了交流学习的地方，提供了很多便利，但如果使用不当，比如将包含了账号密码、密钥等配置文件的代码上传了，导致攻击者能发现并进一步利用这些泄露的信息，就是一个典型的Github敏感信息泄露漏洞。

## 2. 解决思路
### 2.1. 新人培训和规章制度的完善是提升安全意识的必要手段
新入职员工往往这方面的意识为0，可以设置对新入职员工的安全培训。主要讲下在工作和生活中因为意识不足会导致的一些安全问题，让新人对此有个基础的意识，知道上传Github代码会有哪些风险。并将其加入到内部的信息安全守则文档中，使其有据可罚，对恶意上传者起到一定的威慑，对于老员工也有一定的意识提升。进一步可以细化Github开源规范，让开源流程化，比如让安全审核接入进去评估。

### 2.2. 技术是解决意识问题最有效的手段
#### 2.2.1. 内外网隔离
从代码最终泄露的结果上看，直接影响是外网可访问的接口被利用，比如邮箱账号密码泄露的话会被攻击者所登陆、数据库使用的是外网IP等。
所以可以先从内外网隔离来做，规范代码中统一使用内部接口、内部IP，迫不得已的外部接口可以通过增加二次验证、源IP访问限制等策略进行加固。
这样泄露出去的代码无法对企业直接操作影响，至于代码本身存在的一些漏洞就需要依靠白盒代码审计日积月累了。

#### 2.2.2. 实时监控
将代码泄露的风险降低后，代码毕竟是公司资产，还是需要进一步的解决。所以实时的监控很有必要，我们如果能在第一时间内发现泄露的信息并及时删除，所造成的影响将会被降到最低。

### 2.3. 如何实时监控GitHub敏感信息泄露？
监控核心思路可以通过GitHub搜索代码中的特征来发现泄露的信息。

同类型项目Hawkeye使用的是代理爬取的方式进行定期搜索，但代理爬取的方式有诸多弊端，最大缺点是爬取的时候GitHub是一个黑盒，你不知道他是什么频率限制规则，也不知道他什么时候改变规则，一切都存在不确定性。

虽然GitHub API也有频率限制，但他的文档中明确了频率兼职的策略，我们可以通过做好频率控制避免触发GitHub API限制规则。

## 3. 最佳实践
按照一次完整的调用：搜索->分页->详情->代码，则完成一次完整的搜索匹配过程需要调用多次API，而搜索的结果内容数量会直接影响到分页的数量，根据Github文档可以知道单个Token的频率限制为5000R/H，在监控的目标不多的时候，单个Token是可以承受住的。

### 3.1. 一切从收集特征开始
那如何找到我们的特征呢，GitHub作为一个开源**代码**托管平台，代码首当其中，但也会有人将GitHub仅当做版本控制系统来管理自己的文档、资料。这类资料都有一个共同特征，里面包含企业的专属特征。代码中接口的调用包含内部API地址、代码头部包含企业的Copyright信息、代码包名包含企业的主域名等。

#### 3.1.1. 常见几类特征
- 内部域名，内网接口使用的域名、测试域名等，比如`mogujie.org`
- 外部域名，对外使用的域名，可以选一些风险较高的，比如`mail.mogujie.com`
- 代码版权，代码头部注释中的版权声明，比如`Copyright 2018 Meili-Inc. All Rights Reserved`
- 主机域名，服务器HOST域名，比如`goods.db.mogujie.host`
- 代码包名，Java代码包名，比如`com.mogujie.goods`

#### 3.1.2. 如何找到其它企业内部特征？
可以从域名特征入手，最简单的通过一些特定关键词(ex. corp/dev/inc/pre/test/copyright)搜索GitHub代码，根据代码人工确认是否是误报。找到某个确定是该企业的工程后，分析改工程其它类型的特征即可。
比如要找蘑菇街的内部特征，可以通过在GitHub中搜索`mogujie dev`即可找到属于蘑菇街的工程，继而我们再从这类工程中找到真正的内部域名和其它类型特征。

#### 3.1.3. 了解搜索特性有利于特征收集
- 像其它搜索引擎一样，Github搜索会对内容进行分词，所以搜索的时候应该以单词为单位，如果有词组可以拆开用空格拼接起来搜索。
- 如果遇到一些比较容易出现误报的词，可以使用双引号括起来就行强制搜索，比如`"mi.com"`。
- 特殊字符不会被索引到。

### 3.3. 漏洞的告警与响应
在告警这块早期为了告警速度与响应速度，选择了邮件的方式，在后续的实践过程中我们也尝试想改成管理后台、Slack等形式，但最后比较下来发现邮件是最佳实践。

#### 3.3.1. 漏洞告警实践
- 调快邮件客户端收信的轮询时间
- 将所有客户端调整为imap模式，这样能保证我们在电脑上操作的漏洞结果在手机上状态能同步过来
- 邮件发送频率限制可以通过配置多个邮箱甚至是多个不同运营商的邮箱解决

#### 3.3.2. 漏洞响应实践
使用邮件来管理这类漏洞，证实存在的漏洞可以打上星标，继而提交给对应厂商或发送给应急响应小组。而证实误报的可以删到垃圾桶，定期通过优化代码和规则解决；

### 3.4. 误报与漏报
通过我们积累下来，发现目前主要

#### 3.4.1. 误报
- Github博客，比如`github.io github.com`
- Android项目，比如`app/src/main`
- 爬虫，比如`crawler spider scrapy 爬虫`
- 插件，比如`surge adblock .pac`
- Link，比如`"<a href <iframe src ]("`
- 其它，比如`linux_command_set domains jquery sdk linux contact readme hosts authors .html .apk`

#### 3.4.2. 漏报
我们可以不断补充规则来覆盖尽可能多的特征场景，但还是避免不了漏报，毕竟不是所有的项目都遵守或符合我们的特征。如果企业安全推动力比较强，可以考虑给所有项目都打上一个文件或者注释，内容可以是一个索引标记，之后就根据这些索引标记输出为规则来确保无漏报。

### 4. 国内现状
为了优化速度及误报问题，我们将国内的漏洞盒子、补天及乌云历史上的厂商都加入到监控列表中进行测试，我们
我们除了针对各个企业的特征外，

整体项目已经开源，移步[https://github.com/FeeiCN/GSIL](https://github.com/FeeiCN/GSIL)
